import{b as O,r as o,h as W,j as i,f as $,c as Z,e as J}from"./index-CDzJiYq6.js";import{i as M,s as n,M as K,T as Q,h as X,c as ee}from"./tableExcel-CSYl1U_U.js";import{C as te}from"./CommonPopup-CuyX368z.js";import{e as y}from"./errorMsgPopup-BRg64j45.js";import{m as se}from"./msgPopup-vJapftwn.js";import"./index-BD8OiV0R.js";const re=u=>({GU:[{value:"TITLE",label:"제목"}]})[u]||[],le={editor:"input",editable:!0},ae=(u,h,a)=>({formatter:m=>{const f=document.createElement("button");return f.className=`btn btn-sm ${h}`,f.innerText=u,f.onclick=()=>a(m.getData()),f}}),ne=(u,h,a,m)=>{const f=u.getRow().getData().FILEID,D=u.getValue();{const b=J.validateVarcharLength(D,100,"제목");if(!b.valid){y(b.error);return}}setTimeout(()=>{a(b=>b.map(L=>{if(String(L.FILEID)===String(f)){const p={...L,[h]:D};return p.isDeleted==="N"&&p.isAdded==="N"&&(p.isChanged="Y"),p}return L})),m.current&&m.current.redraw()},0)},he=()=>{const{user:u}=O(),h=o.useRef(null),a=o.useRef(null),m=o.useRef(!0),f={areas:[{type:"search",fields:[{id:"GU",type:"select",row:1,label:"구분",labelVisible:!0,options:re("GU"),width:"150px",height:"30px",backgroundColor:"#ffffff",color:"#000000",enabled:!0},{id:"searchText",type:"text",row:1,label:"",labelVisible:!1,placeholder:"검색값을 입력하세요",maxLength:100,width:"200px",height:"30px",backgroundColor:"#ffffff",color:"#000000",enabled:!0}]},{type:"buttons",fields:[{id:"searchBtn",type:"button",row:1,label:"검색",eventType:"search",width:"80px",height:"30px",backgroundColor:"#00c4b4",color:"#ffffff",enabled:!0}]}]},D=[{id:"filterSelect",label:"",type:"select",options:[{value:"",label:"선택"},{value:"TITLE",label:"제목"},{value:"FILENM",label:"파일명"}]},{id:"filterText",label:"",type:"text",placeholder:"검색값을 입력하세요",width:"200px"}],[b,L]=o.useState(M(f.areas.find(t=>t.type==="search").fields)),[p,P]=o.useState(M(D)),[F,g]=o.useState([]),[E,w]=o.useState(!1),[I,C]=o.useState("initializing"),[U,H]=o.useState(0),[z,G]=o.useState(!1),[B,Y]=o.useState(!1),[x,S]=o.useState({TITLE:"",FILES:[]});o.useEffect(()=>{(!u||!W(u.auth,"userAuthManage"))&&(window.location.href="/")},[u]),o.useEffect(()=>((async()=>{if(await new Promise(e=>setTimeout(e,1e3)),!h.current){console.warn("테이블 컨테이너가 준비되지 않았습니다.");return}try{if(a.current=ee(h.current,[{frozen:!0,headerHozAlign:"center",hozAlign:"center",title:"작업",field:"actions",width:80,visible:!0,...ae("삭제",`btn-danger ${n.deleteButton}`,e=>_(e))},{frozen:!0,headerHozAlign:"center",hozAlign:"center",title:"작업대상",field:"applyTarget",sorter:"string",width:100,formatter:e=>{const s=e.getRow().getData();let l="",d="";if(s.isDeleted==="Y"?(l="삭제",d="isDeleted"):s.isAdded==="Y"?(l="추가",d="isAdded"):s.isChanged==="Y"&&(l="변경",d="isChanged"),!l)return"";const r=document.createElement("div");r.style.display="flex",r.style.alignItems="center",r.style.justifyContent="center",r.style.gap="5px";const c=document.createElement("input");c.type="checkbox",c.checked=s[d]==="Y",c.onclick=()=>{setTimeout(()=>{g(T=>T.map(v=>{if(v.FILEID===s.FILEID){const k={...v,[d]:c.checked?"Y":"N"};return d==="isDeleted"&&!c.checked&&(k.isChanged="N"),d==="isAdded"&&!c.checked?null:k}return v}).filter(Boolean))},0)};const A=document.createElement("span");return A.innerText=l,r.appendChild(c),r.appendChild(A),r}},{headerHozAlign:"center",hozAlign:"center",title:"파일ID",field:"FILEID",sorter:"number",width:100,editable:!1},{headerHozAlign:"center",hozAlign:"left",title:"제목",field:"TITLE",sorter:"string",width:200,...le,cellEdited:e=>ne(e,"TITLE",g,a)},{headerHozAlign:"center",hozAlign:"center",title:"파일명",field:"FILENM",sorter:"string",width:200,editable:!1},{headerHozAlign:"center",hozAlign:"center",title:"파일타입",field:"FILETYPE",sorter:"string",width:100,editable:!1},{headerHozAlign:"center",hozAlign:"right",title:"파일용량",field:"FILESIZE",sorter:"string",width:100,editable:!1},{headerHozAlign:"center",hozAlign:"center",title:"등록일",field:"REGEDT",sorter:"string",width:100,editable:!1},{headerHozAlign:"center",hozAlign:"center",title:"등록자",field:"REGEDBY",sorter:"string",width:100,editable:!1}],[],{editable:!0,rowFormatter:e=>{const s=e.getData(),l=e.getElement();l.classList.remove(n.deletedRow,n.addedRow,n.editedRow),s.isDeleted==="Y"?l.classList.add(n.deletedRow):s.isAdded==="Y"?l.classList.add(n.addedRow):s.isChanged==="Y"&&l.classList.add(n.editedRow)}}),!a.current)throw new Error("createTable returned undefined or null");C("ready")}catch(e){C("error"),console.error("Table initialization failed:",e.message)}})(),()=>{a.current&&(a.current.destroy(),a.current=null,C("initializing"))}),[]),o.useEffect(()=>{var e;if(m.current){m.current=!1;return}const t=a.current;if(!(!t||I!=="ready"||E)&&(e=t.rowManager)!=null&&e.renderer)if(t.setData(F),z&&F.length===0&&!E)a.current.alert("검색 결과 없음","info");else{a.current.clearAlert();const s=a.current.getDataCount();H(s)}},[F,E,I,z]),o.useEffect(()=>{if(!a.current||I!=="ready"||E)return;const{filterSelect:t,filterText:e}=p;e&&t?a.current.setFilter(t,"like",e):e&&e!==""?a.current.setFilter([{field:"TITLE",type:"like",value:e},{field:"FILENM",type:"like",value:e}],"or"):a.current.clearFilter()},[p,I,E]);const j=()=>{Y(!1),S({TITLE:"",FILES:[]})},R=t=>{t==="search"?N():t==="showAddPopup"&&Y(!0)},N=async()=>{var t,e;w(!0),G(!0);try{const s={pGUBUN:"LIST",pTITLE:b.searchText||"",pFILEID:"",pRPTCD:"",pDEBUG:"F"},l=await $("excelupload/template/filelist",s);if(!l.success){y(l.message||"데이터를 가져오는 중 오류가 발생했습니다."),g([]);return}if(l.errMsg!==""){g([]);return}const d=Array.isArray(l.data)?l.data:[];g(d.map(r=>({...r,isChanged:"N",isDeleted:"N",isAdded:"N"})))}catch(s){y(((e=(t=s.response)==null?void 0:t.data)==null?void 0:e.message)||"데이터를 가져오는 중 오류가 발생했습니다."),g([])}finally{w(!1)}},V=async()=>{if(!x.TITLE.trim())return{error:"제목을 입력해주세요."};if(!x.FILES.length)return{error:"파일을 선택해 주세요."};const t=new FormData;t.append("gubun","I"),t.append("fileId","0"),t.append("title",x.TITLE),x.FILES.forEach(e=>{t.append("files",e)});try{const e=await Z("excelupload/template/fileupload",t);return e.errCd!=="00"?{error:e.errMsg||"파일 업로드 실패"}:{success:"파일 업로드를 성공했습니다."}}catch(e){return{error:"파일 업로드 중 오류가 발생했습니다: "+e.message}}},_=t=>{setTimeout(()=>{if(t.isAdded==="Y")g(e=>e.filter(s=>s.FILEID!==t.FILEID));else{const e=t.isDeleted==="Y"?"N":"Y";g(s=>s.map(l=>l.FILEID===t.FILEID?{...l,isDeleted:e,isChanged:e==="Y"?"N":l.isChanged}:l))}},0)},q=async t=>{t.preventDefault();const e=F.filter(s=>s.isDeleted==="Y"&&s.isAdded!=="Y"||s.isAdded==="Y"||s.isChanged==="Y"&&s.isDeleted==="N");if(e.length===0){y("변경된 데이터가 없습니다.");return}w(!0);try{const s=e.map(async r=>{let c="";r.isDeleted==="Y"&&r.isAdded!=="Y"?c="D":r.isAdded==="Y"?c="I":r.isChanged==="Y"&&r.isDeleted==="N"&&(c="U");const A={gubun:c,fileId:r.FILEID.toString(),title:r.TITLE||""};try{const T=await $("excelupload/template/filesave",A);if(!T.success)throw new Error(T.message||`Failed to ${c} file ${r.FILEID}`);return{...r,success:!0}}catch(T){return console.error(`Error processing ${c} for FILEID: ${r.FILEID}`,T),{...r,success:!1,error:T.message}}}),d=(await Promise.all(s)).filter(r=>!r.success);d.length>0?y(`일부 작업이 실패했습니다: ${d.map(r=>r.error).join(", ")}`):(se("모든 변경사항이 성공적으로 저장되었습니다."),await N())}catch(s){console.error("Save operation failed:",s),y(s.message||"저장 중 오류가 발생했습니다.")}finally{w(!1)}};return i.jsxs("div",{className:n.container,children:[i.jsx(K,{config:f,filters:b,setFilters:L,onEvent:R}),i.jsx(Q,{filterFields:D,filters:p,setFilters:P,rowCount:U,onDownloadExcel:()=>X(a.current,I,"템플릿관리.xlsx"),buttonStyles:n,children:i.jsxs("div",{className:n.btnGroupCustom,children:[i.jsx("button",{className:`${n.btn} text-bg-primary`,onClick:()=>R("showAddPopup"),children:"추가"}),i.jsx("button",{className:`${n.btn} text-bg-success`,onClick:q,children:"저장"})]})}),i.jsxs("div",{className:n.tableWrapper,children:[I==="initializing"&&i.jsx("div",{children:"초기화 중..."}),E&&i.jsx("div",{children:"로딩 중..."}),i.jsx("div",{ref:h,className:n.tableSection,style:{visibility:E||I!=="ready"?"hidden":"visible"}})]}),i.jsxs(te,{show:B,onHide:j,title:"템플릿 추가",requiresConfirm:!0,confirmMessage:"템플릿을 추가하시겠습니까?",buttons:[{label:"닫기",className:`${n.btn} ${n.btnSecondary} btn btn-secondary`,action:j},{label:"템플릿추가",className:`${n.btn} ${n.btnPrimary} btn text-bg-success`,action:()=>V().then(t=>({result:t,onSuccess:N}))}],children:[i.jsxs("div",{className:"mb-3",children:[i.jsx("label",{className:"form-label",children:"제목"}),i.jsx("input",{type:"text",className:`form-control ${n.formControl}`,value:x.TITLE,onChange:t=>S({...x,TITLE:t.target.value}),placeholder:"템플릿 제목을 입력하세요"})]}),i.jsxs("div",{className:"mb-3",children:[i.jsx("label",{className:"form-label",children:"파일"}),i.jsx("input",{type:"file",className:`form-control ${n.formControl}`,accept:".xlsx,.xls",multiple:!0,onChange:t=>{const e=Array.from(t.target.files||[]);S({...x,FILES:e})}})]})]})]})};export{he as default};
//# sourceMappingURL=ExcelUploadTemplateManage-Da6_s9rX.js.map
